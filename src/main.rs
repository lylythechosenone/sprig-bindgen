use std::{fmt::Debug, fs, io::Write, process::Command};

use base64::{
    alphabet,
    engine::{Engine, GeneralPurpose},
};
use logos::Logos;

#[derive(Logos)]
pub enum ExportFinder<'a> {
    #[regex(r#"export function [^\)]+\)"#)]
    Exported(&'a str),
    #[regex(r#"\s*export function main\(\)"#, logos::skip)]
    #[regex(r#"\s*export function __wbg_set_wasm\(val\)"#, logos::skip)]
    #[regex("[\\s\\S\n]", logos::skip)]
    #[error]
    Error,
}

#[derive(Logos)]
pub enum ExportDecoder<'a> {
    #[regex("export function ", logos::skip)]
    Keywords,

    #[regex(r#"\([^\)]*\)"#, logos::skip)]
    Code,

    #[regex("[a-zA-Z_0-9]+")]
    Name(&'a str),

    #[error]
    #[regex("\\s+", logos::skip)]
    Error,
}

pub struct StrErr(&'static str);
impl Debug for StrErr {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        write!(f, "{}", self.0)
    }
}

fn main() -> Result<(), StrErr> {
    let Some(crate_name) = std::env::args().nth(1) else {
        return Err(StrErr("Expected the first argument to be a crate name"));
    };

    // Build the wasm-pack project
    let Ok(wasm_pack_status) = Command::new("wasm-pack")
        .arg("build")
        .status() else {
            return Err(StrErr("Failed to execute `wasm-pack`. Are you sure it's installed?"));
        };
    if !wasm_pack_status.success() {
        return Err(StrErr("`wasm-pack build` failed"));
    }

    let wasm = fs::read(format!("pkg/{crate_name}_bg.wasm"))
        .expect("You gave me the wrong name, or bindgen is broken");
    let engine = GeneralPurpose::new(&alphabet::STANDARD, Default::default());
    let wasm_str = engine.encode(wasm);
    let js = fs::read_to_string(format!("pkg/{crate_name}_bg.js"))
        .expect("You gave me the wrong name, or bindgen is broken");

    let mut code = format!("\
setLegend(
  ['0', bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  ['1', bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  ['2', bitmap`
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111`],
  ['3', bitmap`
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222`],
  ['4', bitmap`
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333`],
  ['5', bitmap`
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC`],
  ['6', bitmap`
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777`],
  ['7', bitmap`
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555`],
  ['8', bitmap`
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666`],
  ['9', bitmap`
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF`],
  ['a', bitmap`
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444`],
  ['b', bitmap`
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD`],
  ['c', bitmap`
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888`],
  ['d', bitmap`
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH`],
  ['e', bitmap`
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999`],
)
const full_screen = map`
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................`
setMap(full_screen)

const PAGE_SIZE = 65536;
function loadWebAssembly (opts) {{
    let imp = opts && opts.imports
    let wasm = toUint8Array('{wasm_str}')
    let ready = null
    let mod = {{
        buffer: wasm,
        memory: null,
        exports: null,
        realloc: realloc,
        onload: onload
    }}

    onload(function () {{}})

    return mod
    
    function realloc (size) {{
        if (size <= mod.memory.byteLength) return
        mod.exports.memory.grow(Math.ceil(Math.max(0, (size - mod.memory.byteLength) / PAGE_SIZE)))
        mod.memory = new Uint8Array(mod.exports.memory.buffer)
    }}

    function onload (cb) {{
        if (mod.exports) return cb()
        if (ready) {{
            ready.then(cb.bind(null, null)).catch(cb)
            return
        }}
        try {{
            if (opts && opts.async) throw new Error('async')
            setup({{instance: new WebAssembly.Instance(new WebAssembly.Module(wasm), imp)}})
        }} catch (err) {{
            console.error(err)
            ready = WebAssembly.instantiate(wasm, imp).then(setup)
        }}
        onload(cb)
    }}
    function setup (w) {{
        mod.exports = w.instance.exports
        mod.memory = mod.exports.memory && mod.exports.memory.buffer && new Uint8Array(mod.exports.memory.buffer)
    }}
}}
function toUint8Array (s) {{
    if (typeof atob === 'function') return new Uint8Array(atob(s).split('').map(charCodeAt))
    return (require('buf' + 'fer').Buffer).from(s, 'base64')
}}
function charCodeAt (c) {{
    return c.charCodeAt(0)
}}

");

    code.push_str(&js);

    code.push_str("__wbg_set_wasm(loadWebAssembly({imports: { './");
    code.push_str(&crate_name);
    code.push_str("_bg.js': {\n");

    let export_finder = ExportFinder::lexer(&js);
    for (item, span) in export_finder.spanned() {
        if let ExportFinder::Exported(exported) = item {
            let mut decoder = ExportDecoder::lexer(exported);
            let name = match decoder.next().unwrap() {
                ExportDecoder::Name(name) => name,
                _ => unreachable!(),
            };
            code.push_str(&format!("    {name}: {name},\n"));
        } else {
            println!("{span:?}");
        }
    }
    code.push_str("}}}).exports);\n");
    code.push_str(
        "\nif (wasm === null) {\n   console.error(\"Failed to load wasm\");\n}\nwasm.main()",
    );

    let mut file =
        fs::File::create(format!("pkg/{crate_name}.js")).expect("Failed to create a file");
    file.write_all(code.replace("export ", "").as_bytes())
        .expect("Failed to write to file");

    Ok(())
}
